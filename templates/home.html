{% extends "base.html" %}

{% block content %}

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/form_validator.js"></script>

<div class="container col-md-12">
  <div class="home_cover">
    <!-- home left side section (main_home) -->
    <div class=" col-md-9 col-sm-9 main_home">
      <div class="col-md-12 col-sm-12">
      {% if announcements%}
      <!-- announcement section -->
        <div class="alert alert-warning alert-dismissable" style="margin-top: 10px;">
          <h4 style="text-align:center; color:#f00">Announcements</h4>
            <a href="#" class="close" data-dismiss="alert" aria-label="close">Ã—</a>
            <ol>
              {% for announcement in announcements reversed %}
                <li><strong>{{announcement.title}}: </strong>{{announcement.description|force_escape|urlizetrunc:50|linebreaksbr}}</li>
              {% endfor %}
            </ol>
        </div>
        {% endif %}
        <!-- Introductory message -->
        <h2><strong>Tola</strong>Work</h2>
        <p class="font7">Get help setting up, using and configuring TolaActivity, TolaTables, Mobile Data collection platforms and M&E in general. Use tickets to report any issues with <strong>Tola</strong>Data tools, request and vote on new features.</p>
        <br/>
        <!--  add ticket button -->
        {% if user.is_authenticated %}
        <span>
        <button class="btn btn-md btn-success" type="submit" data-toggle="modal" data-target="#ticketModal"><b><span class="glyphicon glyphicon-plus"></span></b> Enter a Ticket</button>&nbsp;
        <button class="btn btn-md btn-info" type="submit" data-toggle="modal" data-target="#fundingModal">Get a Project Quote</button>
        </span>
        {% endif %}
        {% if not user.is_authenticated %}
          <a href="{% url 'login' %}" role="button"  class="btn btn-lg btn-success "><b><span class="glyphicon glyphicon-plus"></span></b> Enter a Ticket</a>
        {% endif %}

        <!-- the tickets, tasks and tools section -->
        <br/>
        <h4>Tasks</h4>
        <div class="home-bottom">
          <div class="panel_bottom">
            <div class="panel-group" id="accordion">

              <!-- the tasks section -->
              {% if user.is_authenticated %}
                <div class="panel panel-success">
                  <div class="panel-heading ">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-parent="#accordion" href="#tasks"> <font > <span class="glyphicon glyphicon-tasks"></span>&nbsp;&nbsp;Tasks</font></a>
                    </h4>
                  </div>
                  <!-- the collapse section for tasks -->
                  <div id="tasks" class="panel-collapse collapse">
                  {% if recent_tasks %}
                    <div class="panel-body">
                     <!--  task labels -->
                      <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#recent_tasks"><b><span class="glyphicon glyphicon-list-alt"></span></b>&nbsp;&nbsp;Recent Tasks</a></li>
                        <li><a data-toggle="tab" href="#tasks_preview"><b><span class="glyphicon glyphicon-th-list"></span></b>&nbsp;&nbsp;Tasks Preview</a></li>
                      </ul>
                      <!-- tasks display -->
                      <div class="tab-content">
                        <!-- recent tasks section -->
                        <div id="recent_tasks" class="tab-pane fade in active">
                          <div class="panel-body table-responsive">
                            <table class="table table-striped table-bordered">
                              <tr class="info">
                                <td><strong>Task Title</strong></td>
                                <td><strong>Start Date</strong></td>
                                <td><strong>Due Date</strong></td>
                                <td><strong>Status</strong></td>
                                <td><strong>Priority</strong></td>
                                <td><strong>Assigned To</strong></td>
                              </tr>

                              {% for task in recent_tasks.reverse|slice:"5" %}
                              <tr>  <td><strong><a href= "{% url 'task' task.id %} ">{{ task.task }}</a></strong></td>
                                <td>{{ task.created_date | date}}</td>
                                <td>{{ task.due_date | date}}</td>
                                 <td> {% if task.status == 1 %} Active {%elif task.status == 2%}Re-Opened{% elif task.status == 3%}Closed{% elif task.status == 4%}Cancelled  {% endif %}</td>
                                  <td> {% if task.priority == 1 %} High {% elif task.priority == 2 %} Normal {% elif task.priority == 3 %} Low {% endif %}</td>

                                <td>{{task.assigned_to}}</td>
                              </tr>
                              {% endfor %}
                            </table>
                          </div>
                        </div> <!-- end recent tasks section -->

                        <!-- tasks preview section -->
                        <div id="tasks_preview" class="tab-pane fade">
                          <div class="panel panel-info ">
                            <div class="panel-heading">
                              <strong><a href='{% url 'task_list' %}'>Total Tasks</a> <span class="badge read_more">{{ num_tasks }}</span></strong>
                            </div>
                            <!-- tasks panel body -->
                            <div class="panel-body">
                              <!-- begin tasks created -->
                              <div class="sort_panels" >
                                <div class= "preview_links">
                                   <a href="#tasks_created" data-toggle="collapse">Tasks Created </a> <strong> <span class="badge read_more"> {{ total_tasks_created }} </span></strong>
                                </div>
                                <!-- the collapse section for tasks created -->
                                <div id="tasks_created" class="collapse in">
                                  {% if tasks_created %}
                                    <div class="table-responsive">
                                      <table class="table table-striped table-bordered">
                                        <tr class="info">
                                          <td><strong>Task Title</strong></td>
                                          <td><strong>Start Date</strong></td>
                                          <td><strong>Due Date</strong></td>
                                          <td><strong>Status</strong></td>
                                          <td><strong>Priority</strong></td>
                                          <td><strong>Assigned To</strong></td>
                                        </tr>
                                        {% for task in tasks_created.reverse|slice:"5" %}
                                        <tr>
                                          <td><strong><a href= "{% url 'task' task.id %} ">{{ task.task }}</a></strong></td>
                                          <td>{{ task.created_date | date}}</td>
                                          <td>{{ task.due_date | date}}</td>
                                          <td> {% if task.status == 1 %} Active {%elif task.status == 2%}Re-Opened{% elif task.status == 3%}Completed{% elif task.status == 4%}Cancelled  {% endif %}</td>
                                          <td> {% if task.priority == 1 %} High {% elif task.priority == 2 %} Normal {% elif task.priority == 3 %} Low {% endif %}</td>
                                          <td>{{task.assigned_to}}</td>
                                          {% endfor %}
                                        </tr>
                                      </table>
                                    </div>
                                  {% else %}
                                    <div class="alert alert-info" role="alert">
                                      <h5>You currently have no tasks Go to <a href='{% url 'task_list' %}' class="alert-link">Tasks</a> to create a task(s)</h5>
                                    </div>
                                  {% endif %}
                                  </div>
                                </div> <!-- end tasks created -->

                                <!-- tasks assigned -->
                                <div class="sort_panels" >
                                  <div class= "preview_links">
                                    <a href="#tasks_assigned" data-toggle="collapse">Tasks Assigned </a> <strong> <span class="badge read_more"> {{ total_tasks_assigned }} </span></strong>
                                  </div>
                                 <!--  the collapse section for tasks assigned -->
                                  <div id="tasks_assigned" class="collapse">
                                    {% if tasks_assigned %}
                                      <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                          <tr class="info">
                                            <td><strong>Task Title</strong></td>
                                            <td><strong>Start Date</strong></td>
                                            <td><strong>Due Date</strong></td>
                                            <td><strong>Status</strong></td>
                                            <td><strong>Priority</strong></td>
                                            <td><strong>Assigned To</strong></td>
                                          </tr>
                                          {% for task in tasks_assigned.reverse|slice:"5" %}
                                          <tr>
                                            <td><strong><a href= "{% url 'task' task.id %} ">{{ task.task }}</a></strong></td>
                                            <td>{{ task.created_date | date}}</td>
                                            <td>{{ task.due_date | date}}</td>
                                            <td> {% if task.status == 1 %} Active {%elif task.status == 2%}Re-Opened{% elif task.status == 3%}Completed{% elif task.status == 4%}Cancelled  {% endif %}</td>
                                            <td> {% if task.priority == 1 %} High {% elif task.priority == 2 %} Normal {% elif task.priority == 3 %} Low {% endif %}</td>
                                            <td>{{task.assigned_to}}</td>
                                            {% endfor %}
                                          </tr>
                                        </table>
                                      </div>
                                    {% else %}
                                      <div class="alert alert-info" role="alert">
                                        <h5>You currently have no tasks assigned to you</h5>
                                      </div>
                                    {% endif %}
                                  </div> <!-- end the collapse section for tasks assigned -->
                                </div> <!-- end tasks assigned -->

                                <!-- tasks completed -->
                                <div class="sort_panels" >
                                  <div class= "preview_links">
                                    <a href="#tasks_completed" data-toggle="collapse">Tasks Completed </a> <strong> <span class="badge read_more"> {{ total_tasks_completed }} </span></strong>
                                  </div>
                                  <!-- the collapse section for tasks completed -->
                                  <div id="tasks_completed" class="collapse">
                                    {% if tasks_completed %}
                                      <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                          <tr class="info">
                                            <td><strong>Task Title</strong></td>
                                            <td><strong>Start Date</strong></td>
                                            <td><strong>Due Date</strong></td>
                                            <td><strong>Status</strong></td>
                                            <td><strong>Priority</strong></td>
                                            <td><strong>Assigned To</strong></td>
                                          </tr>
                                          {% for task in tasks_completed %}
                                          <tr>
                                            <td><strong><a href= "{% url 'task_list' %}">{{ task.task }}</a></strong></td>
                                            <td>{{ task.created_date | date}}</td>
                                            <td>{{ task.due_date | date}}</td>
                                            <td> {% if task.status == 1 %} Active {%elif task.status == 2%}Re-Opened{% elif task.status == 3%}Completed{% elif task.status == 4%}Cancelled  {% endif %}</td>
                                            <td> {% if task.priority == 1 %} High {% elif task.priority == 2 %} Normal {% elif task.priority == 3 %} Low {% endif %}</td>
                                            <td>{{task.assigned_to}}</td>
                                            {% endfor %}
                                          </tr>
                                        </table>
                                      </div>
                                    {% else %}
                                      <div class="alert alert-info" role="alert">
                                        <h5>You currently have no tasks completed by you</h5>
                                      </div>
                                    {% endif %}
                                  </div> <!-- end the collapse section for tasks completed  -->
                                </div> <!-- end tasks completed -->

                              </div> <!-- end tasks panel body -->
                          </div>
                        </div> <!-- end task preview section -->
                      </div> <!-- end tasks display -->
                    </div>
                  {% else %}
                    <div class="alert alert-info" role="alert">
                      <h5>You currently have no tasks Go to <a href='{% url 'task_list' %}' class="alert-link">Tasks</a> to create a task(s)</h5>
                    </div>
                  {% endif %}
                  </div> <!-- end the collapse section for tasks -->
                </div>
              {% endif %}
              <!-- end tasks section -->



            </div>
          </div>
        </div>
        <!-- end of the tickets, tasks and tools section -->
      </div>
    </div> <!-- end main_home -->

    <!-- home right side section (minor_home) -->
    <div class="row">
      <div class="col-md-3 col-sm-3 minor_home">
        <div class="search" >
          <form class="input-group" id='searchform' method='get' action="{% url 'helpdesk_list' %}">
            <input type="text" name='q' class="form-control" placeholder="Search tickets" id='q'>
            <span class="input-group-btn">
              <button class="btn btn-info" type="button" onclick="submit_query()"><span class="glyphicon glyphicon-search"></span>
            </button>
            </span>
            <script type="text/javascript">
              function submit_query(){
                 var input = document.getElementById("q").value;
                  if (input!==""){ 
                  window.location.href =  '{% url 'helpdesk_list' %}?{% if query_string %}{{ query_string }}&{% endif %}q='+input;
                  }
                  else
                    alert("kindly enter a search term");
              }
          </script>
          </form>
        </div>
        {% if user.is_superuser %}
          <div class=" githubsync">
            <a href="#" class="btn btn-info" onClick="github_sync()"><b><span class="glyphicon glyphicon-refresh"></span></b> Sync Tickets with Github</a>
          </div>
        {% endif %}
        <br/>
        <!-- users logged_in section -->
        <div class="panel panel-info">
          <div class="panel-heading">
            Users Online
          </div>
          <div id="active_users">

            {% if logged_users%}
              {% for logged_user in logged_users%}
                <p><span class="glyphicon glyphicon-user"></span> {{logged_user.username}}
                  {% if user.is_authenticated and request.user.username == logged_user.username %} (You){% endif %}
                 [TW] <a href="{% url 'user' %}?email={{logged_user.email}}&username={{logged_user.username}}">&nbsp;View Tasks</a></p>
              {% endfor %}
            {% endif %}

            {%if tolaActivityData.activity_logged_users %}
              {% for logged_user in tolaActivityData.activity_logged_users %}
                 <p><span class="glyphicon glyphicon-user"></span> {{logged_user.username}} [TA] &nbsp;<a href="{% url 'user' %}?email={{logged_user.email}}&username={{logged_user.username}}">&nbsp;View Tasks</a></p>
              {% endfor %}
            {% endif %}

            {%if tolaTablesData.table_logged_users %}
              {% for logged_user in tolaTablesData.table_logged_users %}
                 <p><span class="glyphicon glyphicon-user"></span> {{logged_user.username}} [TT] <a href="{% url 'user' %}?email={{logged_user.email}}&username={{logged_user.username}}">&nbsp;View Tasks</a></p>
              {% endfor %}
            {% endif %}
          </div>
        </div> <!-- end users logged_in section -->
        <div class="panel panel-info">
          <div class="panel-heading">
            Top Enhancement Requests
          </div>
          <div class="panel-body" id="enhancement">
            <div class="table-responsive">
              <table class="table table-condensed">
                <tr>
                  <th>Votes</th>
                  <th>Title</th>
                </tr>
                {% for item in votes_tickets %}
                <tr>
                  <td>{{ item.votes }}</td>
                  <td><a href="/helpdesk/tickets/{{ item.id }}/">{{ item.title }}</a></td>
                </tr>
                {% endfor %}
              </table>
            </div>
          </div><!-- end top enhancement -->
        </div>
    </div> <!-- end minor_home -->
    
  </div> <!-- end home_cover -->
</div> <!-- end container -->
</div>

<!-- add funding opportunity modal -->
<div class="modal fade " id="fundingModal" role="dialog">
  <div class="modal-dialog task_form modal-lg">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h3 class="modal-title font9">Get a Project Quote</h3>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          <p>Please describe your project in detail and someone from the TolaData team will get back to you with a quote on how long it would take us to complete and when we could get started.</p>
          <p><b>*</b> is a required field</p>
        </div>
        <form class="form-horizontal" method='post' name="funding_form" id="f_opportunity-form">
        {% csrf_token %}
        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Name:<b>*</b></strong></p></label>
              <div class=" col-md-8">
                <input class="form-control" type='text' name='name' id='id_name'/>
              </div>
            </div> 
        </div>
        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Phone:<b>*</b></strong></p></label>
              <div class=" col-md-8">
                <input class="form-control" type='text' name='phone' id='id_phone'/>
              </div>
            </div> 
        </div>
        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Email:<b>*</b></strong></p></label>
              <div class=" col-md-8">
                <input class="form-control" type='text' name='email' id='id_email'/>
              </div>
            </div> 
        </div>
        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Project Description:<b>*</b></strong></p></label>
              <div class=" col-md-8">
                <textarea class="form-control" name="project_description" id='id_project_description' rows="4"></textarea>
              </div>
            </div> 
        </div>
        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Project's Start Date:<b>*</b></strong></p></label>
              <div class=" col-md-8">
                  <script>
                      $( function() {
                        $( "#id_project_start_date" ).datepicker({
                          dateFormat: "yy-mm-dd"
                        });
                      } );
                    </script>
                <input class="form-control" type='text' name='project_start_date' id='id_project_start_date'/>

              </div>
            </div> 
        </div>
        <div class=" row task_spacing ">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Total Estimated Amount:<b>*</b></strong></p></label>
              <div class=" col-md-8 input-group">
                <span class="input-group-addon">$</span>
                <input class="form-control" type='number' name='total_estimated_amount' id='id_total_estimated_amount'/>
              </div>
            </div> 
        </div>

        <div class=" row task_spacing">
            <div class="col-md-12 ticket_padding row ticket_edit">
              <label class="col-md-3"><p><strong>Additional Comments:</strong></p></label>
              <div class=" col-md-8">
                <textarea class="form-control" name="project_description" id='id_additional_comments' rows="4" ></textarea>
              </div>
            </div> 
        </div>

        <div class='buttons form-group '>
          <input type='submit' class="btn btn-primary col-md-offset-3" value='Submit' />
        </div>
       </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div> 
  </div>
</div>
<!-- end add Funding Opportunity modal -->
<script>
  $("#id_tags").select2({
              tags: true,
              allowClear: false,

      });
</script>
<script>
    $(document).ready(function() {

        $('#id_preset').change(function() {
            preset = $('#id_preset').val();
            if (preset != '') {
                $.get("{% url 'helpdesk_raw' "preset" %}?id=" + preset, function(data) {
                    $("#commentBox").val(data)
                });
            }
        });

        $("[data-toggle=tooltip]").tooltip();
    });


    $('#f_opportunity-form').on('submit', function(event){
          event.preventDefault();
          create_post();
      });

</script>

{% endblock content %}
